function globalSearch() {
  if( !search_template ) return;
  const searchHistory = new BlendedStorage("allopharmacy_");
  if( typeof searchHistory.datas.search_history == "undefined" ) searchHistory.add("search_history", []);

  const cloneTemplate = search_template.content.cloneNode(true);
  cloneTemplate.actors = {};
  cloneTemplate.querySelectorAll("[data-actor]").forEach(_ => cloneTemplate.actors[_.dataset.actor] = _);

  cloneTemplate.actors.input.value = $_GET.search ? $_GET.search : "";

  cloneTemplate.actors.root.onclick = function(e) {
    if( e.target != this ) return;
    this.remove();
  }

  cloneTemplate.actors.form.onsubmit = function(e) {
    e.preventDefault();
    $_GET.search = this.data.search;
    if( $_GET.search.trim().length <= 0 ) return;

    var url = "";
    Object.keys($_GET).map((key, i) => {
      if( key == "page" ) return;
      if(url.trim().length) url += "&";
      var value = $_GET[key];
      url += `${key}=${encodeURIComponent(value)}`;
    });

    if( !searchHistory.datas.search_history.includes($_GET.search) ) {
      let updatedHistory = searchHistory.datas.search_history;
      updatedHistory.push($_GET.search);
      searchHistory.update("search_history", updatedHistory);
    }

    window.location.href = `?${url}`;
    return false;
  }

  searchHistory.datas.search_history.reverse().map(_ => {
    `<li tabindex="-1">${_}</li>`.toTemplate().appendTo(cloneTemplate.actors.history);
  });

  cloneTemplate.actors.history.onclick = function(e) {
    if( !e.target || e.target.tagName != "LI" ) return;
    var value = e.target.innerText;
    cloneTemplate.actors.input.value = value;
  }

  app_main.appendChild(cloneTemplate);
}

function goNextPage(page) {
  $_GET.page = parseInt(page) + 1;
  return window.location.href =`?${Object.entries($_GET).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join("&")}`;
}
function goPrevPage(page) {
  $_GET.page = parseInt(page) - 1;
  return window.location.href =`?${Object.entries($_GET).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join("&")}`;
}
